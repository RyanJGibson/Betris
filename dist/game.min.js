!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("PIXI")):"function"==typeof define&&define.amd?define("betris",["PIXI"],t):"object"==typeof exports?exports.betris=t(require("PIXI")):e.betris=t(e.PIXI)}(window,function(i){return a={},o.m=n=[function(e,t,i){e.exports=i(1)},function(e,t,i){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){void 0===n&&(n=i),e[n]=t[i]}),o=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&n(t,e,i);return o(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GameManager=void 0;var r=a(i(2)),s=i(3),l=i(4),h=i(5),c=(d.prototype.Init=function(e){console.log("Init"),console.log(e),this.sState=this.eStateEnums.sWait,this.oView.killAllTweens(),this.oModel.createNewDataGrid();var t=this.oModel.getDataGrid();this.oView.renderCells(t),this.oModel.setDropList(e),this.sState=this.eStateEnums.sInitDrop,this.nScore=0,this.oView.setScore(this.nScore),this.oDevUIDiv.style.display="none"},d.prototype.initLoadJSON=function(){var t=this;console.log("initLoadJSON"),fetch("json/config.json").then(function(e){return e.json()}).then(function(e){return t.onDataLoaded(e)})},d.prototype.onDataLoaded=function(e){console.log("onDataloaded"),console.log(e),this.oData=e,this.oContainerDiv=document.createElement("div"),document.body.appendChild(this.oContainerDiv),this.oContainerDiv.setAttribute("id","stage"),this.oContainerDiv.appendChild(this.oApp.view),this.oApp.view.width=this.oData.generic.aCanvasPixelDimensions[0],this.oApp.view.height=this.oData.generic.aCanvasPixelDimensions[1],this.cMainContainer=new r.Container,this.oApp.stage.addChild(this.cMainContainer),this.oModel=new h.Model(this.oData),this.oView=new l.View(this.cMainContainer,this.oData),this.sState=this.eStateEnums.sWait,this.oApp.ticker.add(this.loop.bind(this)),this.oResizeHelper=new s.ResizeHelper(this.oData,this.oContainerDiv)},d.prototype.loop=function(){switch(this.sState){case this.eStateEnums.sWait:break;case this.eStateEnums.sInitDrop:this.initDrop()}},d.prototype.initDrop=function(){var e,t;console.log("initDrop"),this.sState=this.eStateEnums.sWait,this.oModel.addNextShape()?(e=this.oModel.getDataGrid(),this.oView.renderCells(e),t=this.oModel.getNewFallingShapeData(),this.oModel.checkGameOver(t)?(console.log("game over"),this.oDevUIDiv.style.display="block"):this.oView.animateFallingBlocks(t,this.onNewDropComplete.bind(this))):(console.log("out of shapes"),this.oDevUIDiv.style.display="block")},d.prototype.onNewDropComplete=function(){var e=this.oModel.getDataGrid();this.oView.renderCells(e);var t=this.oModel.checkGridForWins();0<t.length?(console.log("We have a winner"),this.nScore+=10*t.length,this.oView.setScore(this.nScore),this.oView.animateRemoveWinningBlocks(t,this.onWinningBlocksRemoved.bind(this))):this.sState=this.eStateEnums.sInitDrop},d.prototype.onWinningBlocksRemoved=function(){console.log("onWinningBlocksRemoved");var e=this.oModel.getFallDataAfterRowsRemoved();0<e.length?(console.log("animate the cascade"),this.oView.animateFallingBlocks(e,this.onCascadeComplete.bind(this))):this.sState=this.eStateEnums.sInitDrop},d.prototype.onCascadeComplete=function(){console.log("onCascadeComplete"),this.sState=this.eStateEnums.sInitDrop},d);function d(){this.nScore=0,this.eStateEnums={sWait:"WAIT",sInitDrop:"INIT_DROP"},(window.Game=this).oDevUIDiv=document.getElementById("devUI"),this.oApp=new r.Application({width:400,height:400,backgroundColor:0,view:document.getElementById("myCanvas")}),this.initLoadJSON()}t.GameManager=c,window.onload=function(){new c}},function(e,t){e.exports=i},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ResizeHelper=void 0;var n=(o.prototype.onResize=function(){var e,t=this.oData.generic.aCanvasPixelDimensions[0],i=this.oData.generic.aCanvasPixelDimensions[1];(window.innerWidth<t||window.innerHeight<i)&&((e=this.oData.generic.aCanvasPixelDimensions[0]/this.oData.generic.aCanvasPixelDimensions[1])<window.innerWidth/window.innerHeight?t=(i=window.innerHeight)*e:i=(t=window.innerWidth)/e),this.oContainerDiv.style.width=t.toString(),this.oContainerDiv.style.height=i.toString(),this.oContainerDiv.style.marginLeft=((window.innerWidth-t)/2).toString(),this.oContainerDiv.style.marginTop=((window.innerHeight-i)/2).toString()},o);function o(e,t){console.log("New ResizeHelper"),this.oData=e,this.oContainerDiv=t,window.addEventListener("resize",this.onResize.bind(this),!0),this.onResize()}t.ResizeHelper=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=t.Cell=void 0;var r=function(){};t.Cell=r;var n=(o.prototype.renderCells=function(e){this.aViewGrid=[],this.cCellContainer.removeChildren();for(var t=0;t<e.length;t++){for(var i=e[t],n=[],o=0;o<i.length;o++)"X"!=i[o]?n.push(this.createNewCell(i[o],o,t)):n.push(null);this.aViewGrid.push(n)}},o.prototype.killAllTweens=function(){TweenMax.killAll()},o.prototype.createNewCell=function(e,t,i){var n=new PIXI.Container,o=new PIXI.Graphics;o.lineStyle(2,0),o.beginFill(this.oData.aShapeLibrary[Number(e)].nColour),o.drawRect(0,0,this.oData.generic.aGridCellPixelDimensions[0],this.oData.generic.aGridCellPixelDimensions[1]),n.addChild(o);var a=new r;return a.nShapeID=e,a.nTileX=t,a.nTileY=i,a.nDestTileX=-1,a.nDestTileY=-1,a.oContainer=n,this.cCellContainer.addChild(a.oContainer),a.oContainer.x=a.nTileX*this.oData.generic.aGridCellPixelDimensions[0],a.oContainer.y=a.nTileY*this.oData.generic.aGridCellPixelDimensions[1],a},o.prototype.animateFallingBlocks=function(e,t){console.log("animateFallingBlocks");for(var i=0,n=0;n<e.length;n++){var o=e[n],a=this.aViewGrid[o.nTileY][o.nTileX];a.nDestTileY=a.nTileY+o.nFallDist,TweenMax.to(a.oContainer,o.nFallDist/this.oData.generic.nDropSpeed,{ease:window.Power1.easeIn,y:a.nDestTileY*this.oData.generic.aGridCellPixelDimensions[1],onComplete:function(){++i==e.length&&t()}.bind(this)})}},o.prototype.animateRemoveWinningBlocks=function(e,t){console.log("animateRemoveWinningBlocks");for(var i=0,n=e.length*this.oData.generic.aGridTileDimensions[0],o=0,a=0;a<e.length;a++)for(var r=0;r<this.oData.generic.aGridTileDimensions[0];r++){var s=this.aViewGrid[e[a]][r];TweenMax.to(s.oContainer,.25,{alpha:0,delay:o/30+.1,onComplete:function(){++i==n&&t()}.bind(this)}),o++}},o.prototype.createGrid=function(){console.log("createGrid"),console.log(this.oData),this.cGridContainer=new PIXI.Container,this.cMainContainer.addChild(this.cGridContainer);for(var e=0;e<this.oData.generic.aGridTileDimensions[0];e++)for(var t=0;t<this.oData.generic.aGridTileDimensions[1]+this.oData.generic.nGridSpawnAreaHeight;t++){var i=new PIXI.Graphics;i.lineStyle(2,this.oData.generic.nGridLineColour),i.beginFill(this.oData.generic.nGridCellColour),i.drawRect(0,0,this.oData.generic.aGridCellPixelDimensions[0],this.oData.generic.aGridCellPixelDimensions[1]),i.x=this.oData.generic.aGridCellPixelDimensions[0]*e,i.y=this.oData.generic.aGridCellPixelDimensions[1]*t,this.cGridContainer.addChild(i),t<this.oData.generic.nGridSpawnAreaHeight&&(i.alpha=.5)}var n=this.oData.generic.aGridTileDimensions[0]*this.oData.generic.aGridCellPixelDimensions[0],o=(this.oData.generic.aGridTileDimensions[1]+this.oData.generic.nGridSpawnAreaHeight)*this.oData.generic.aGridCellPixelDimensions[1];this.cGridContainer.x=(this.oData.generic.aCanvasPixelDimensions[0]-n)/2,this.cGridContainer.position.y=(this.oData.generic.aCanvasPixelDimensions[1]-o)/2,this.cCellContainer=new PIXI.Container,this.cCellContainer.x=this.cGridContainer.x,this.cCellContainer.y=this.cGridContainer.y,this.cMainContainer.addChild(this.cCellContainer)},o.prototype.createScoreField=function(){this.tScoreField=new PIXI.Text("Score: 0",{fontFamily:"Arial",fontSize:14,fill:16777215,align:"center"}),this.cMainContainer.addChild(this.tScoreField),this.tScoreField.position.x=10,this.tScoreField.position.y=this.oData.generic.aCanvasPixelDimensions[1]-30},o.prototype.setScore=function(e){this.tScoreField.text="Score: "+e},o);function o(e,t){console.log("New View"),this.cMainContainer=e,this.oData=t,this.createGrid(),this.createScoreField()}t.View=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Model=void 0;var n=(o.prototype.setDropList=function(e){if(console.log("setDropList:  "+e),this.aCurrentDropList=[],-1<e)this.aCurrentDropList=JSON.parse(JSON.stringify(this.oData.aDropLists[e]));else{console.log("creating random drop list");for(var t=0;t<200;t++){var i={nColumn:0,nShape:parseInt((5*Math.random()).toString()),nRotation:parseInt((4*Math.random()).toString())},n=this.aShapeLibrary[i.nShape];i.nRotation=i.nRotation%n.aRotations.length;var o=n.aRotations[i.nRotation][0].length;i.nColumn=parseInt((Math.random()*(this.oData.generic.aGridTileDimensions[0]-o+1)).toString()),this.aCurrentDropList.push(i)}}},o.prototype.createNewDataGrid=function(){this.aDataGrid=[];for(var e=0;e<this.oData.generic.aGridTileDimensions[1]+this.oData.generic.nGridSpawnAreaHeight;e++){for(var t=[],i=0;i<this.oData.generic.aGridTileDimensions[0];i++)t.push("X");this.aDataGrid.push(t)}this.devDataGrid()},o.prototype.getDataGrid=function(){for(var e=JSON.parse(JSON.stringify(this.aDataGrid)),t=0;t<e.length;t++)for(var i=e[t],n=0;n<i.length;n++)"@"==i[n]&&(i[n]=this.oCurrentShapeLibData.nID);return e},o.prototype.getCurrentShapeLibData=function(){return this.oCurrentShapeLibData},o.prototype.checkGameOver=function(e){return console.log("checkGameOver"),this.bFallingShapeStuckInSpawnArea},o.prototype.addNextShape=function(){if(this.bFallingShapeStuckInSpawnArea=!1,0<this.aCurrentDropList.length){var e=this.aCurrentDropList[0],t=this.aShapeLibrary[e.nShape];e.nRotation=e.nRotation%t.aRotations.length;var i=t.aRotations[e.nRotation];this.oCurrentShapeDropListData=e,this.oCurrentShapeLibData=t,this.oCurrentShapeLibData.nID=e.nShape;var n=t.aRotations[e.nRotation][0].length;t.aRotations[e.nRotation].length,e.nColumn+n>this.oData.generic.aGridTileDimensions[0]&&(e.nColumn=this.oData.generic.aGridTileDimensions[0]-n);for(var o=0;o<i.length;o++)for(var a=i[o],r=0;r<a.length;r++)1==a[r]&&(this.aDataGrid[o][r+e.nColumn]="@");return this.aCurrentDropList.shift(),!0}return!1},o.prototype.devDataGrid=function(){},o.prototype.getNewFallingShapeData=function(){for(var e=[],t=this.oData.generic.aGridTileDimensions[1]+this.oData.generic.nGridSpawnAreaHeight,i=t-this.oCurrentShapeLibData.aRotations[this.oCurrentShapeDropListData.nRotation].length,n=0;n<this.aDataGrid.length;n++)for(var o=this.aDataGrid[n],a=0;a<o.length;a++)if("@"==o[a]){o[a]="X";var r={nFallDist:0,nTileX:a,nTileY:n};e.push(r);for(var s=0;s<t;s++){var l=n+s;l<t&&"@"!=this.aDataGrid[l][a]&&"X"!=this.aDataGrid[l][a]&&s-1<i&&(i=s-1)}}for(var h=0,n=0;n<e.length;n++){var c=e[n];c.nFallDist=i,this.aDataGrid[c.nTileY+c.nFallDist][c.nTileX]=this.oCurrentShapeLibData.nID,c.nTileY+c.nFallDist<4&&h++}return h==e.length&&(this.bFallingShapeStuckInSpawnArea=!0),e},o.prototype.checkGridForWins=function(){for(var e=[],t=0;t<this.aDataGrid.length;t++){for(var i=this.aDataGrid[t],n=0,o=0;o<i.length;o++)"X"!=i[o]&&n++;n==i.length&&(console.log("Full Row at: "+t),e.push(t))}return e},o.prototype.getFallDataAfterRowsRemoved=function(){var e=[],t=this.checkGridForWins();t.reverse();for(var i=!1,n=0,o=this.aDataGrid.length-1;0<o;o--)if(i=!1,o==t[0]&&(t.shift(),i=!0),i)n++;else for(var a,r=this.aDataGrid[o],s=0;s<r.length;s++)"X"!=r[s]&&(a={nFallDist:n,nTileX:s,nTileY:o},e.push(a));for(var l=(t=this.checkGridForWins()).length,h=[],c=JSON.parse(JSON.stringify(this.aDataGrid)),o=0;o<this.aDataGrid.length;o++)o!=t[0]?h.push(c[o]):t.shift();for(o=0;o<l;o++){for(var d=[],s=0;s<this.oData.generic.aGridTileDimensions[0];s++)d.push("X");h.unshift(d)}return this.aDataGrid=h,e},o.prototype.drawGridToConsole=function(){for(var e=0;e<this.aDataGrid.length;e++){for(var t=this.aDataGrid[e],i=" ",n=0;n<t.length;n++)i+=t[n];i+="  "+e,console.log(i)}},o);function o(e){this.bFallingShapeStuckInSpawnArea=!1,console.log("New Model"),this.oData=e,this.createNewDataGrid(),this.nDropListToUse=this.oData.generic.nDefaultDropList,console.log(this.nDropListToUse),console.log(this.oData.aDropLists),this.aCurrentDropList=this.oData.aDropLists[this.nDropListToUse],console.log(this.aCurrentDropList),this.aShapeLibrary=this.oData.aShapeLibrary,console.log("this.aShapeLibrary"),console.log(this.aShapeLibrary)}t.Model=n}],o.c=a,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0);function o(e){if(a[e])return a[e].exports;var t=a[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var n,a});